
Java 21
Spring Boot 3.2.0
MyBatis Plus 3.5.5
MySQL 8.0.5



## 2025-11-23

---

### 1.1 版本管理问题
**问题描述：**
- 根 pom.xml 使用 `${revision}` 变量
- 部分子模块使用硬编码版本号 `1.0.0`
- 版本不统一导致依赖管理混乱

**修复方案：**
- 统一所有子模块使用 `${revision}` 变量
- 在根 pom.xml 中定义 `<revision>1.0.0</revision>`
- 使用 flatten-maven-plugin 在打包时替换版本号

### 1.2 relativePath 配置错误
**问题描述：**
- 多个子模块的 `<relativePath>` 设置为 `./pom.xml`
- 正确应该是 `../pom.xml`（指向父目录的 pom.xml）

**修复方案：**
- 修改所有子模块的 relativePath 为 `../pom.xml`

### 1.3 GroupId 不统一
**问题描述：**
- 不同模块使用了不同的 groupId
    - `com.junoyi.module.system`
    - `com.junoyi.framework`
    - `com.junoyi.system`

**修复方案：**
- 统一所有模块使用 `com.junoyi` 作为 groupId
- 通过 artifactId 区分不同模块

### 1.4 dependencies 模块不完整
**问题描述：**
- junoyi-dependencies 模块缺少对内部模块的版本管理
- 缺少常用第三方依赖的版本定义
- 未继承父 pom

**修复方案：**
- 添加 parent 引用
- 完善内部模块的版本管理
- 添加常用第三方依赖（MyBatis Plus、Druid、Hutool等）

---

## 2025-12-06

- 重构项目工程，将cn.junoyi重构改成com.junoyi
- 启动器模块，初始化启动配置
- 获取LOGO静态图片
- 完成sys_user表、sys_role表、sys_user_role表

---

## 2025-12-09

### 2.1 Spring Boot 配置优化
**优化内容：**
- 优化 `application-local.yml` 配置文件结构
- 规范化数据源、Druid、Redis、Redisson 配置
- 移除冗余注释，提升配置可读性
- 添加配置分组注释，便于维护

### 2.2 ObjectMapper 自动装配问题
**问题描述：**
- `junoyi-framework-redis` 模块无法自动装配 `ObjectMapper`
- 缺少 Jackson 相关依赖

**解决方案：**
1. 在 `junoyi-framework-redis/pom.xml` 添加 `jackson-databind` 依赖
2. 在 `RedisConfig.java` 的 `redissonAutoConfigurationCustomizer()` 方法添加 `@Bean` 注解
3. 识别并计划移除 `junoyi-framework-core` 中冗余的 `JacksonConfig`（已存在于 `junoyi-framework-json`）

### 2.3 Spring AutoConfiguration 配置错误
**问题描述：**
- `META-INF.spring` 目录名称错误，应为 `META-INF/spring`
- 导致 Spring Boot 无法识别自动配置

**解决方案：**
- 修正目录结构为 `META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports`

### 2.4 BeanPostProcessor 警告处理
**问题描述：**
- Lock4j 相关 Bean 初始化过早，导致 BeanPostProcessor 警告
- 警告信息：`Bean 'lock4j-...' is not eligible for getting processed by all BeanPostProcessors`

**解决方案：**
1. 尝试通过 `@AutoConfigureAfter` 调整加载顺序（效果不佳）
2. 最终通过日志配置屏蔽警告：
   ```yaml
   logging:
     level:
       org.springframework.context.support.PostProcessorRegistrationDelegate: ERROR
       io.netty.resolver.dns: ERROR
   ```

**结论：**
- 该警告不影响功能和性能
- Lock4j 作为基础设施类库，早期加载是正常且预期的行为

### 2.5 数据源模块开发（junoyi-framework-datasource）

#### 2.5.1 模块设计与依赖配置
**创建内容：**
- 更新 `pom.xml`，添加核心依赖：
  - MyBatis Plus (`mybatis-plus-boot-starter`)
  - 动态数据源 (`dynamic-datasource-spring-boot-starter`)
  - Druid 连接池 (`druid-spring-boot-starter`)
  - MySQL 驱动 (`mysql-connector-j`)
  - Spring Boot Configuration Processor

**依赖问题解决：**
- 修正依赖名称（从 `spring-boot3-starter` 改为标准命名）
- 添加 `junoyi-framework-log` 依赖（拦截器需要日志功能）

#### 2.5.2 核心功能实现

**1. 数据源切换注解**
- 创建 `@DataSource` 注解，支持方法级和类级标注
- 定义 `DataSourceType` 枚举（MASTER、SLAVE、LOG、REPORT）

**2. AOP 切面实现**
- 创建 `DataSourceAspect` 切面类
- 实现数据源动态切换逻辑
- 优先级设置为 `@Order(1)`，确保在事务切面之前执行
- 自动清理数据源上下文，避免内存泄漏

**3. MyBatis-Plus 配置**
- 创建 `MyBatisPlusConfig` 配置类
- 集成插件：
  - 分页插件（单页最大 1000 条限制）
  - 乐观锁插件
  - 防全表更新/删除插件

**4. SQL 监控拦截器**
- `SqlBeautifyInterceptor`：SQL 美化输出
  - 格式化 SQL 语句，提升可读性
  - 输出参数信息便于调试
- `SlowSqlInterceptor`：慢 SQL 监控
  - 可配置阈值（默认 3000ms）
  - 记录执行时间、SQL 和参数

**5. 配置管理**
- 创建 `DataSourceProperties` 配置属性类
- 支持配置项：
  - `sql-beautify-enabled`：SQL 美化开关
  - `slow-sql-enabled`：慢 SQL 监控开关
  - `slow-sql-threshold`：慢 SQL 阈值
  - `sql-log-enabled`：SQL 日志开关

**6. 自动配置**
- 创建 `AutoConfiguration.imports` 文件
- 创建 `spring-configuration-metadata.json` 配置元数据
- 在 `MyBatisPlusConfig` 添加 `@EnableConfigurationProperties`

#### 2.5.3 配置文件优化

**application-local.yml 配置：**
```yaml
spring:
  datasource:
    dynamic:
      primary: master
      strict: true
      datasource:
        master:
          driver-class-name: com.mysql.cj.jdbc.Driver
          url: jdbc:mysql://localhost:3306/junoyi?...
          username: root
          password: 123456
      druid:
        initial-size: 5
        min-idle: 5
        max-active: 20
        filters: stat,wall
```

**application.yml 配置：**
```yaml
spring:
  profiles:
    active: local

junoyi:
  datasource:
    sql-beautify-enabled: true
    slow-sql-enabled: true
    slow-sql-threshold: 3000
```

#### 2.5.4 启动配置修复

**问题描述：**
- 应用启动失败：`Failed to configure a DataSource`
- 原因：Spring Boot 默认数据源配置与动态数据源冲突

**解决方案：**
- 在 `JunoYiServerApplication` 启动类添加排除配置：
  ```java
  @SpringBootApplication(
      scanBasePackages = {"com.junoyi"},
      exclude = {DataSourceAutoConfiguration.class}
  )
  ```

#### 2.5.5 模块集成

**依赖引入：**
- 在 `junoyi-framework-stater/pom.xml` 添加 datasource 模块依赖
- 确保数据源模块被正确编译和加载

**代码优化：**
- 补充完整 `DataSourceType` 枚举的 LOG 类型定义
- 优化拦截器代码注释和文档
- 格式化代码，统一代码风格

### 2.6 技术栈总结

**核心技术：**
- Java 21
- Spring Boot 3.3.5
- MyBatis Plus 3.5.5
- Dynamic DataSource
- Druid 1.2.20
- MySQL 8.0.33

**实现功能：**
- ✅ 多数据源动态切换
- ✅ Druid 连接池管理
- ✅ SQL 美化输出
- ✅ 慢 SQL 监控
- ✅ MyBatis-Plus 自动配置（分页、乐观锁、防误操作）
- ✅ SQL 防火墙（防注入）
- ✅ 逻辑删除支持

### 2.7 问题与解决

**问题列表：**
1. ✅ Maven JDK 版本不匹配（需要 Java 21）
2. ✅ 数据源模块未被引用导致编译跳过
3. ✅ 日志模块依赖缺失
4. ✅ 配置属性元数据缺失
5. ✅ 数据源配置路径错误
6. ✅ Profile 未激活导致配置不生效

**经验总结：**
- 使用动态数据源时必须排除 Spring Boot 默认数据源配置
- 配置元数据文件能提供更好的 IDE 支持
- AOP 切面的优先级很重要，需要在事务之前执行
- 日志配置可以有效屏蔽框架内部的无害警告

---

