# 对象转换使用指南

JunoYi 框架使用 MapStruct 实现 DTO/BO/PO/VO 之间的对象转换，编译期生成代码，零运行时开销。

## 对象职责划分

| 类型 | 全称 | 职责 | 位置 |
|------|------|------|------|
| DTO | Data Transfer Object | 接收前端请求参数 | `domain/dto/` |
| BO | Business Object | Service 层业务处理 | `domain/bo/` |
| PO | Persistent Object | 数据库实体映射 | `domain/po/` |
| VO | View Object | 返回给前端的数据 | `domain/vo/` |

## 快速开始

### 1. 创建 Converter 接口

在业务模块的 `convert` 包下创建转换器接口：

```java
package com.junoyi.system.convert;

import com.junoyi.framework.core.convert.BaseConverter;
import com.junoyi.framework.core.convert.MapStructConfig;
import com.junoyi.system.domain.dto.SysUserDTO;
import com.junoyi.system.domain.po.SysUser;
import com.junoyi.system.domain.vo.SysUserVO;
import org.mapstruct.Mapper;
import org.mapstruct.factory.Mappers;

@Mapper(componentModel = "spring", config = MapStructConfig.class)
public interface SysUserConverter extends BaseConverter<SysUserDTO, SysUser, SysUserVO> {

    SysUserConverter INSTANCE = Mappers.getMapper(SysUserConverter.class);
}
```

### 2. 使用转换器

**方式一：静态调用（推荐在工具类或静态方法中使用）**

```java
// 单个对象转换
SysUserVO vo = SysUserConverter.INSTANCE.toVo(user);
SysUser entity = SysUserConverter.INSTANCE.toEntity(dto);

// 列表转换
List<SysUserVO> voList = SysUserConverter.INSTANCE.toVoList(userList);
```

**方式二：Spring 注入（推荐在 Service/Controller 中使用）**

```java
@Service
@RequiredArgsConstructor
public class SysUserServiceImpl implements ISysUserService {

    private final SysUserConverter userConverter;

    @Override
    public SysUserVO getUserById(Long userId) {
        SysUser user = userMapper.selectById(userId);
        return userConverter.toVo(user);
    }
}
```

## BaseConverter 提供的方法

| 方法 | 说明 |
|------|------|
| `toEntity(D dto)` | DTO 转 Entity |
| `toVo(E entity)` | Entity 转 VO |
| `dtoToVo(D dto)` | DTO 直接转 VO |
| `toEntityList(List<D>)` | DTO 列表转 Entity 列表 |
| `toVoList(List<E>)` | Entity 列表转 VO 列表 |
| `updateEntity(D dto, E entity)` | 将 DTO 的非空字段更新到 Entity |

## 自定义映射规则

### 字段名不同

```java
@Mapper(componentModel = "spring", config = MapStructConfig.class)
public interface SysUserConverter extends BaseConverter<SysUserDTO, SysUser, SysUserVO> {

    @Override
    @Mapping(source = "phonenumber", target = "phone")
    @Mapping(source = "userName", target = "account")
    SysUserVO toVo(SysUser entity);
}
```

### 忽略某个字段

```java
@Override
@Mapping(target = "password", ignore = true)
@Mapping(target = "salt", ignore = true)
SysUserVO toVo(SysUser entity);
```

### 自定义转换逻辑

```java
@Mapper(componentModel = "spring", config = MapStructConfig.class)
public interface SysUserConverter extends BaseConverter<SysUserDTO, SysUser, SysUserVO> {

    @Override
    @Mapping(target = "statusText", source = "status", qualifiedByName = "statusToText")
    SysUserVO toVo(SysUser entity);

    @Named("statusToText")
    default String statusToText(Integer status) {
        return status == 0 ? "正常" : "停用";
    }
}
```

### 多个源对象合并

```java
@Mapping(source = "user.userId", target = "userId")
@Mapping(source = "user.userName", target = "userName")
@Mapping(source = "dept.deptName", target = "deptName")
SysUserVO toVo(SysUser user, SysDept dept);
```

## 全局配置说明

`MapStructConfig` 提供了以下默认配置：

```java
@MapperConfig(
    componentModel = "spring",           // 注册为 Spring Bean
    unmappedTargetPolicy = IGNORE,       // 忽略未映射的目标属性
    unmappedSourcePolicy = IGNORE,       // 忽略未映射的源属性
    nullValuePropertyMappingStrategy = IGNORE,  // null 值不覆盖目标属性
    nullValueCheckStrategy = ALWAYS      // 映射前检查 null
)
```

## 目录结构规范

```
junoyi-module-xxx/
├── src/main/java/com/junoyi/xxx/
│   ├── controller/          # 控制器
│   ├── service/             # 服务层
│   ├── convert/             # 对象转换器 ⭐
│   │   └── XxxConverter.java
│   └── ...

junoyi-module-xxx-api/
├── src/main/java/com/junoyi/xxx/
│   ├── domain/
│   │   ├── dto/             # 请求参数 ⭐
│   │   │   └── XxxDTO.java
│   │   ├── vo/              # 返回数据 ⭐
│   │   │   └── XxxVO.java
│   │   ├── po/              # 数据库实体 ⭐
│   │   │   └── Xxx.java
│   │   └── bo/              # 业务对象（可选）
│   │       └── XxxBO.java
│   └── ...
```

## 编译说明

MapStruct 在编译期生成实现类，执行以下命令后可在 `target/generated-sources/annotations` 目录下查看生成的代码：

```bash
mvn clean compile
```

## 常见问题

### Q: 编译后找不到 Converter 实现类？

确保 `pom.xml` 中配置了 `maven-compiler-plugin` 的 `annotationProcessorPaths`，且 Lombok 在 MapStruct 之前。

### Q: Lombok 的 getter/setter 没有被识别？

需要添加 `lombok-mapstruct-binding` 依赖，框架已在 `junoyi-module` 父 pom 中统一配置。

### Q: 如何调试生成的代码？

查看 `target/generated-sources/annotations` 目录下的 `XxxConverterImpl.java` 文件。
