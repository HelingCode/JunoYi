# 滑块验证码前端使用指南

## API 接口

### 获取滑块验证码

```
GET http://localhost:7588/captcha/slider
```

**响应示例：**
```json
{
  "code": 200,
  "data": {
    "captchaId": "a1b2c3d4e5f6",
    "type": "SLIDER",
    "backgroundImage": "data:image/png;base64,iVBORw0KGgo...",
    "sliderImage": "data:image/png;base64,iVBORw0KGgo...",
    "backgroundWidth": 310,
    "backgroundHeight": 155,
    "expireSeconds": 120
  }
}
```

### 验证滑块

```
POST http://localhost:7588/captcha/validate/slider
Content-Type: application/x-www-form-urlencoded
```

**请求参数：**
- `captchaId`: 验证码ID
- `pointJson`: 滑块位置 JSON，格式 `{"x":100,"y":5}`

> 注意：`y` 值可以是任意数字（如 5），后端只验证 `x` 坐标

---

## 关键说明

**滑块图片定位原理：** AJ-Captcha 生成的滑块图片与背景图等高(155px)，拼图块已经在正确的 Y 位置，其余部分是透明的。前端只需将滑块图片叠加在背景图左上角 `(0, 0)`，用户水平拖动即可。

---

## 前端实现

### HTML 结构

```html
<div class="captcha-container">
  <div class="captcha-image-wrapper">
    <img id="captcha-bg" class="captcha-bg" alt="背景图">
    <img id="captcha-slider" class="captcha-slider" alt="滑块">
  </div>
  <div class="slider-track">
    <div id="slider-btn" class="slider-btn">→</div>
    <span class="slider-tip">向右拖动滑块完成验证</span>
  </div>
  <div id="captcha-result" class="captcha-result"></div>
</div>
```

### CSS 样式

```css
.captcha-container {
  width: 310px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

.captcha-image-wrapper {
  position: relative;
  width: 310px;
  height: 155px;
  border-radius: 4px;
  overflow: hidden;
  background: #f5f5f5;
}

.captcha-bg {
  width: 310px;
  height: 155px;
  display: block;
}

.captcha-slider {
  position: absolute;
  top: 0;
  left: 0;
  height: 155px;
  pointer-events: none;
}

.slider-track {
  position: relative;
  width: 310px;
  height: 40px;
  margin-top: 10px;
  background: #e8e8e8;
  border-radius: 20px;
  overflow: hidden;
}

.slider-btn {
  position: absolute;
  left: 0;
  top: 0;
  width: 50px;
  height: 40px;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: grab;
  font-size: 18px;
  color: #1890ff;
  user-select: none;
  z-index: 1;
}

.slider-btn:active { cursor: grabbing; }

.slider-tip {
  position: absolute;
  width: 100%;
  text-align: center;
  line-height: 40px;
  color: #999;
  font-size: 14px;
}

.captcha-result {
  margin-top: 10px;
  text-align: center;
  font-size: 14px;
}

.captcha-result.success { color: #52c41a; }
.captcha-result.error { color: #ff4d4f; }
```

### JavaScript 实现

```javascript
class SliderCaptcha {
  constructor(options = {}) {
    this.baseUrl = options.baseUrl || 'http://localhost:7588';
    this.captchaId = null;
    this.sliderX = 0;
    this.maxX = 260; // 310 - 50(按钮宽度)
    this.init();
  }

  async init() {
    await this.loadCaptcha();
    this.bindEvents();
  }

  async loadCaptcha() {
    try {
      const res = await fetch(`${this.baseUrl}/captcha/slider`);
      const json = await res.json();
      
      if (json.code === 200 && json.data) {
        const data = json.data;
        this.captchaId = data.captchaId;
        
        document.getElementById('captcha-bg').src = 
          `data:image/png;base64,${data.backgroundImage}`;
        document.getElementById('captcha-slider').src = 
          `data:image/png;base64,${data.sliderImage}`;
        
        this.reset();
      }
    } catch (e) {
      console.error('加载验证码失败:', e);
    }
  }

  bindEvents() {
    const btn = document.getElementById('slider-btn');
    let startX = 0;
    let isDragging = false;

    const onStart = (e) => {
      isDragging = true;
      startX = (e.touches ? e.touches[0].clientX : e.clientX) - this.sliderX;
      btn.style.cursor = 'grabbing';
    };

    const onMove = (e) => {
      if (!isDragging) return;
      e.preventDefault();
      
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      let x = clientX - startX;
      x = Math.max(0, Math.min(x, this.maxX));
      
      this.sliderX = x;
      btn.style.left = x + 'px';
      document.getElementById('captcha-slider').style.left = x + 'px';
    };

    const onEnd = () => {
      if (!isDragging) return;
      isDragging = false;
      btn.style.cursor = 'grab';
      this.verify();
    };

    // 鼠标事件
    btn.addEventListener('mousedown', onStart);
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onEnd);

    // 触摸事件
    btn.addEventListener('touchstart', onStart, { passive: true });
    document.addEventListener('touchmove', onMove, { passive: false });
    document.addEventListener('touchend', onEnd);
  }

  async verify() {
    const resultEl = document.getElementById('captcha-result');
    
    try {
      const params = new URLSearchParams();
      params.append('captchaId', this.captchaId);
      params.append('pointJson', JSON.stringify({ x: Math.round(this.sliderX), y: 5 }));

      const res = await fetch(`${this.baseUrl}/captcha/validate/slider`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
      });
      
      const json = await res.json();
      
      if (json.code === 200 && json.data === true) {
        resultEl.textContent = '✓ 验证成功';
        resultEl.className = 'captcha-result success';
      } else {
        resultEl.textContent = '✗ 验证失败，请重试';
        resultEl.className = 'captcha-result error';
        setTimeout(() => this.loadCaptcha(), 1000);
      }
    } catch (e) {
      resultEl.textContent = '验证请求失败';
      resultEl.className = 'captcha-result error';
    }
  }

  reset() {
    this.sliderX = 0;
    document.getElementById('slider-btn').style.left = '0px';
    document.getElementById('captcha-slider').style.left = '0px';
    document.getElementById('captcha-result').textContent = '';
    document.getElementById('captcha-result').className = 'captcha-result';
  }
}

// 使用
new SliderCaptcha({ baseUrl: 'http://localhost:7588' });
```

---

## 配置说明

后端配置 (`application.yml`)：
```yaml
junoyi:
  captcha:
    slider:
      width: 310
      height: 155
      tolerance: 5      # 验证容差(像素)
      water-mark: JunoYi
```

## Vue 3 组件示例

```vue
<template>
  <div class="captcha-container">
    <div class="captcha-image-wrapper">
      <img :src="bgSrc" class="captcha-bg" />
      <img :src="sliderSrc" class="captcha-slider" :style="{ left: sliderX + 'px' }" />
    </div>
    <div class="slider-track">
      <div class="slider-btn" :style="{ left: sliderX + 'px' }" @mousedown="onStart" @touchstart="onStart">→</div>
    </div>
    <div :class="['captcha-result', resultType]">{{ resultText }}</div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue';

const props = defineProps({ baseUrl: { type: String, default: 'http://localhost:7588' } });
const emit = defineEmits(['success', 'fail']);

const captchaId = ref('');
const bgSrc = ref('');
const sliderSrc = ref('');
const sliderX = ref(0);
const resultText = ref('');
const resultType = ref('');

let isDragging = false, startX = 0;
const maxX = 260;

async function loadCaptcha() {
  const res = await fetch(`${props.baseUrl}/captcha/slider`);
  const { data } = await res.json();
  captchaId.value = data.captchaId;
  bgSrc.value = `data:image/png;base64,${data.backgroundImage}`;
  sliderSrc.value = `data:image/png;base64,${data.sliderImage}`;
  sliderX.value = 0;
  resultText.value = '';
  resultType.value = '';
}

function onStart(e) {
  isDragging = true;
  startX = (e.touches?.[0]?.clientX ?? e.clientX) - sliderX.value;
}

function onMove(e) {
  if (!isDragging) return;
  const x = Math.max(0, Math.min((e.touches?.[0]?.clientX ?? e.clientX) - startX, maxX));
  sliderX.value = x;
}

async function onEnd() {
  if (!isDragging) return;
  isDragging = false;
  
  const params = new URLSearchParams();
  params.append('captchaId', captchaId.value);
  params.append('pointJson', JSON.stringify({ x: Math.round(sliderX.value), y: 5 }));
  
  const res = await fetch(`${props.baseUrl}/captcha/validate/slider`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: params
  });
  const { data } = await res.json();
  
  if (data === true) {
    resultText.value = '✓ 验证成功';
    resultType.value = 'success';
    emit('success', captchaId.value);
  } else {
    resultText.value = '✗ 验证失败';
    resultType.value = 'error';
    emit('fail');
    setTimeout(loadCaptcha, 1000);
  }
}

onMounted(() => {
  loadCaptcha();
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
  document.addEventListener('touchmove', onMove);
  document.addEventListener('touchend', onEnd);
});

onUnmounted(() => {
  document.removeEventListener('mousemove', onMove);
  document.removeEventListener('mouseup', onEnd);
  document.removeEventListener('touchmove', onMove);
  document.removeEventListener('touchend', onEnd);
});
</script>
```
